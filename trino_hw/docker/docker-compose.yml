version: "3.8"

# üîπ –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Airflow
x-airflow-common:
  &airflow-common
  image: apache/airflow:2.9.0
  environment:
    AIRFLOW__CORE__EXECUTOR: SequentialExecutor
    AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: sqlite:////opt/airflow/airflow.db
    AIRFLOW__WEBSERVER__RBAC: "True"
    AIRFLOW__WEBSERVER__AUTHENTICATE: "False"
  volumes:
    - ./airflow/dags:/opt/airflow/dags
    - ./airflow/logs:/opt/airflow/logs
  restart: unless-stopped
  networks:
    - analytics_net

services:
  # üåÄ Airflow
  airflow:
    <<: *airflow-common
    container_name: airflow
    command: >
      bash -c "
        airflow db migrate &&
        airflow users create --username admin --firstname admin --lastname admin --role Admin --password admin --email admin@example.com &&
        airflow webserver & airflow scheduler
      "
    ports:
      - "8080:8080"

  # üóÇÔ∏è MinIO (S3-compatible storage)
  minio:
    image: minio/minio
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./minio_data:/data
    restart: unless-stopped
    networks:
      - analytics_net

networks:
  analytics_net:
    driver: bridge
